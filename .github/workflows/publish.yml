name: Build and Release

on:
  push:
    tags:
      - 'v*'   # æ¨é€ tag æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2

    - name: Restore NuGet packages
      run: nuget restore subs-check.win.gui.sln

    - name: Build project
      run: msbuild subs-check.win.gui.csproj /p:Configuration=Release

    # ç”±äº subs-check.win.gui.csproj çš„ PostBuildCleanup ç›®æ ‡ä¼šåˆ é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼Œå› æ­¤è¿™é‡Œç›´æ¥æ‰“åŒ… bin/Release ç›®å½•ä¸‹çš„å†…å®¹å³å¯
    # - name: Package artifact
    #   run: |
    #     shopt -s extglob
    #     mkdir -p release
    #     cp -r bin/Release/*.exe release/
    #     cp -r bin/Release/!(*.Wpf).dll release/
    #     cp -r bin/Release/runtimes release/
    #     cp -r bin/Release/zh release/
    #   shell: bash

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: subs-check-win
        path: bin/release/
        if-no-files-found: error # å¦‚æœæ²¡æœ‰æ–‡ä»¶ï¼ŒæŠ¥é”™

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: master

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: subs-check-win
        path: release

    - name: Prepare tags (delete local tags then fetch remote tags cleanly)
      id: tags
      run: |
        CURRENT_TAG="${GITHUB_REF#refs/tags/}"
        echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
        PREV_TAG=$(git tag --sort=-creatordate | grep -v "^${CURRENT_TAG}$" | head -n1 || true)
        echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
      shell: bash

    - name: Create ZIP archive
      run: |
        cd release
        zip -r subs-check-win.zip .
      shell: bash

    # ç”¨ git-cliff ç”Ÿæˆå¹¶æ›´æ–° CHANGELOG.mdï¼ˆèŒƒå›´ï¼šPREV_TAG..CURRENT_TAGï¼‰
    - name: Generate changelog with git-cliff
      uses: orhun/git-cliff-action@v4
      id: git-cliff
      with:
        config: cliff.toml
        args: ${{ steps.tags.outputs.prev_tag && format('{0}..{1}', steps.tags.outputs.prev_tag, steps.tags.outputs.current_tag) || steps.tags.outputs.current_tag }} -o CHANGELOG.md

    # ç”¨ git-cliff ç”Ÿæˆ Release bodyï¼ˆèŒƒå›´ï¼šPREV_TAG..CURRENT_TAGï¼‰
    - name: Generate changelog with git-cliff (release body)
      uses: orhun/git-cliff-action@v4
      id: git-cliff-release
      with:
        config: cliff-release.toml
        args: ${{ steps.tags.outputs.prev_tag && format('{0}..{1}', steps.tags.outputs.prev_tag, steps.tags.outputs.current_tag) || steps.tags.outputs.current_tag }}

    - name: Generate update.xml
      run: |
        CURRENT_TAG="${{ steps.tags.outputs.current_tag }}"
        VERSION="${CURRENT_TAG#v}"   # å»æ‰å¼€å¤´çš„ v

        cat > update.xml <<EOF
        <?xml version="1.0" encoding="utf-8"?>
        <item>
            <version>${VERSION}</version>
            <url>https://gh.39.al/https://github.com/sinspired/SubsCheck-Win-GUI/releases/download/${CURRENT_TAG}/subs-check-win.zip</url>
            <changelog>https://gh.39.al/https://raw.githubusercontent.com/sinspired/SubsCheck-Win-GUI/master/CHANGELOG.md</changelog>
            <mandatory>true</mandatory>
            <executable>subs-check.win.gui.exe</executable>
        </item>
        EOF

    - name: Commit changelog and update.xml
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

        git add CHANGELOG.md update.xml
        if git diff --cached --quiet; then
          echo "No changes in CHANGELOG.md or update.xml"
          exit 0
        fi

        git commit -m "chore(release): update CHANGELOG.md and update.xml for ${{ steps.tags.outputs.current_tag }}"
        git push

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        body: ${{ steps.git-cliff-release.outputs.content }}
        files: release/subs-check-win.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Send Telegram message on push
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }} # é¢‘é“ ID
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }} # Bot Token
        format: markdown
        message: |
          ğŸ’» *subs-check_GUI æ›´æ–°(æ¨è)*

          ç‰ˆæœ¬: `${{ github.ref_name }}`
          é¡¹ç›®: `${{ github.repository }}`
          æ›´æ–°è¯´æ˜:
            - æ”¯æŒé«˜å¹¶å‘å†…æ ¸æ–°ç‰¹æ€§
            - æ”¯æŒç»Ÿè®¡è®¢é˜…é“¾æ¥ä¿¡æ¯
            - ä¼˜åŒ–é»˜è®¤å‚æ•°ï¼Œæé«˜æ£€æµ‹æˆåŠŸç‡
            - æ–°å†…æ ¸é›†æˆ sub-store å‰åç«¯ï¼Œå¯é€šè¿‡WebUIä¸€é”®ç®¡ç†

          ğŸ”— [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }})